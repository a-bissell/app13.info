<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>app13.info - Now Playing</title>
<script src="https://unpkg.com/@ruffle-rs/ruffle/ruffle.js"></script>
<style>
body {
    background-color: #ffffff;
    color: #000000;
    font-family: Verdana, Arial, Helvetica, sans-serif;
    font-size: 12px;
    margin: 0;
    padding: 0;
    text-align: center;
}
a { color: #0000ee; }
a:visited { color: #551a8b; }
a:hover { color: #ff0000; }
#game-container {
    display: inline-block;
    background-color: #000000;
    border: 1px solid #000000;
    width: 700px;
    height: 525px;
}
#game-container ruffle-player {
    width: 700px;
    height: 525px;
    border: none;
    display: block;
}
#status-msg {
    display: none;
    font-size: 11px;
    color: #555555;
    margin: 10px 0;
}
#error-msg {
    display: none;
    border: 1px solid #cccccc;
    padding: 15px;
    margin: 15px auto;
    max-width: 450px;
    font-size: 11px;
    color: #555555;
}
</style>
</head>
<body>

<br>

<h2 id="game-title">Loading...</h2>

<div id="game-container"></div>

<p id="controls-hint" style="font-size:10px;color:#999999;">Click the game to focus.</p>
<p id="status-msg">Looking up on Flashpoint...</p>

<div id="error-msg">
    <b>Game Not Found</b><br><br>
    This game couldn't be found locally or on Flashpoint Archive.<br><br>
    To add it manually, place the .swf file at:<br>
    <code id="expected-file"></code>
</div>

<p><a href="index.html">&laquo; Back to all games</a></p>

<script>
window.RufflePlayer = window.RufflePlayer || {};

var FLASHPOINT_API = "https://db-api.unstable.life";
var FLASHPOINT_PLAYER = "https://ooooooooo.ooo/";

window.addEventListener("DOMContentLoaded", function() {
    var params = new URLSearchParams(window.location.search);
    var game = params.get("game");

    if (!game) {
        window.location.href = "index.html";
        return;
    }

    var gameName = game.replace(/[-_]/g, " ").replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    document.getElementById("game-title").textContent = gameName;
    document.title = "app13.info - " + gameName;
    document.getElementById("expected-file").textContent = "games/" + game + ".swf";

    var swfPath = "games/" + game + ".swf";
    var container = document.getElementById("game-container");

    // Step 1: HEAD request to check if the .swf actually exists before
    // handing it to Ruffle — Ruffle silently swallows 404s and never
    // rejects its load() promise, so we can't rely on .catch() for that.
    fetch(swfPath, { method: "HEAD" })
        .then(function(resp) {
            if (resp.ok) {
                loadWithRuffle(swfPath, container);
            } else {
                goToFlashpoint(gameName, container);
            }
        })
        .catch(function() {
            goToFlashpoint(gameName, container);
        });
});

function loadWithRuffle(swfPath, container) {
    var ruffle = window.RufflePlayer.newest();
    if (!ruffle) {
        // Ruffle CDN not yet ready — retry once after a short delay
        setTimeout(function() {
            var r = window.RufflePlayer.newest();
            if (r) {
                var p = r.createPlayer();
                p.style.width = "700px";
                p.style.height = "525px";
                container.appendChild(p);
                p.load(swfPath);
            }
        }, 500);
        return;
    }
    var player = ruffle.createPlayer();
    player.style.width = "700px";
    player.style.height = "525px";
    container.appendChild(player);
    player.load(swfPath);
}

function goToFlashpoint(gameName, container) {
    container.innerHTML = "";
    container.style.backgroundColor = "#ffffff";
    container.style.border = "none";
    document.getElementById("controls-hint").style.display = "none";
    lookupFlashpoint(gameName, container);
}

function lookupFlashpoint(gameName, container) {
    var statusMsg = document.getElementById("status-msg");
    statusMsg.style.display = "block";

    var url = FLASHPOINT_API + "/search?title=" + encodeURIComponent(gameName)
        + "&fields=id,title,platform,launchCommand&limit=10";

    fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(results) {
            statusMsg.style.display = "none";

            // Prefer Flash platform entries
            var flashResults = results.filter(function(r) {
                return r.platform && r.platform.toLowerCase().indexOf("flash") !== -1;
            });
            var match = flashResults.length > 0 ? flashResults[0] : results[0];

            if (!match || !match.id) {
                showError();
                return;
            }

            showFlashpointPlayer(match.id, container);
        })
        .catch(function() {
            statusMsg.style.display = "none";
            showError();
        });
}

function showFlashpointPlayer(id, container) {
    var playUrl = FLASHPOINT_PLAYER + "?id=" + id;

    container.style.backgroundColor = "#ffffff";
    container.style.border = "1px solid #cccccc";
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.alignItems = "center";
    container.style.justifyContent = "center";
    container.style.gap = "12px";

    var msg = document.createElement("p");
    msg.style.margin = "0";
    msg.style.fontSize = "12px";
    msg.style.color = "#555555";
    msg.textContent = "This game is available via Flashpoint Archive.";

    var btn = document.createElement("a");
    btn.href = playUrl;
    btn.target = "_blank";
    btn.textContent = "Play on Flashpoint Archive";
    btn.style.fontSize = "13px";
    btn.style.fontWeight = "bold";

    var note = document.createElement("p");
    note.style.margin = "0";
    note.style.fontSize = "10px";
    note.style.color = "#999999";
    note.textContent = "(opens in a new tab)";

    container.appendChild(msg);
    container.appendChild(btn);
    container.appendChild(note);
}

function showError() {
    document.getElementById("game-container").style.display = "none";
    document.getElementById("error-msg").style.display = "block";
}
</script>

</body>
</html>
